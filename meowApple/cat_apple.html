
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meow Apple</title>
    <style>
        /* CSS æ ·å¼éƒ¨åˆ† */
        /* ğŸ‘‡ === æ›¿æ¢æ•´ä¸ª CSS === */
        body {
            margin: 0;
            display: flex;
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center;     /* å‚ç›´å±…ä¸­ */
            height: 100vh;           /* å æ»¡å…¨å±é«˜åº¦ */
            background-color: #001336;
            font-family: 'Courier New', monospace;
            overflow: hidden;        /* ç¦æ­¢æ»šåŠ¨ */
            touch-action: none;      /* ç¦æ­¢ç³»ç»Ÿç¼©æ”¾/åé€€æ‰‹åŠ¿ */
        }

        #game-container {
            position: relative;

            /* ğŸ‘‡ æ ¸å¿ƒé€‚é…é€»è¾‘ ğŸ‘‡ */
            width: 90%;             /* é»˜è®¤å 90%å®½åº¦ (é€‚é…æ‰‹æœºç«–å±) */
            max-width: 1000px;        /* ç”µè„‘ä¸Šæœ€å¤§ä¸è¶…è¿‡ 800px */

            /* å¼ºåˆ¶ä¿æŒ 2:1 æ¯”ä¾‹ï¼Œæ ¹æ®å®½åº¦è‡ªåŠ¨è®¡ç®—é«˜åº¦ */
            aspect-ratio: 2 / 1;

            /* å¦‚æœå±å¹•ç‰¹åˆ«æ‰ (æ¯”å¦‚æ‰‹æœºæ¨ªå±æ—¶é«˜åº¦ä¸å¤Ÿ)ï¼Œåˆ™æ”¹ç”¨é«˜åº¦é™åˆ¶ */
            max-height: 100vh;

            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: #87CEEB;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            /* ç¡®ä¿ canvas å†…éƒ¨åƒç´ ä¸æ¨¡ç³Š */
            image-rendering: pixelated;
        }

        /* é®ç½©å±‚ (å¼€å§‹/ç»“æŸç•Œé¢) */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            text-align: center;
        }

        .hidden { display: none !important; }

        /* å“åº”å¼å­—ä½“ï¼šæ‰‹æœºä¸Šå­—å·å°ä¸€ç‚¹ï¼Œç”µè„‘ä¸Šå¤§ä¸€ç‚¹ */
        h1 { margin: 0 0 10px 0; font-size: clamp(24px, 5vw, 40px); color: #f1c40f; text-shadow: 2px 2px 0 #c0392b; }
        p { font-size: clamp(14px, 3vw, 18px); color: #ecf0f1; margin-bottom: 20px; }

        button {
            padding: 10px 30px;
            font-size: clamp(16px, 4vw, 24px); /* æŒ‰é’®æ–‡å­—è‡ªé€‚åº” */
            cursor: pointer;
            background-color: #e74c3c;
            border: 3px solid #c0392b;
            color: white;
            font-weight: bold;
            border-radius: 50px;
            white-space: nowrap; /* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
        }
        button:active { transform: scale(0.95); background-color: #c0392b; }

        #score-board {
            position: absolute;
            top: 5%;
            left: 5%;
            font-size: clamp(16px, 4vw, 24px); /* åˆ†æ•°æ–‡å­—è‡ªé€‚åº” */
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            z-index: 5;
        }

        #loading-msg { color: #f1c40f; margin-top: 10px; font-size: 12px; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="1000" height="500"></canvas>
    <div id="score-board">Score: 0</div>

    <div id="start-screen" class="overlay">
        <h1>ä¸€é¢—è‹¹æœ</h1>
        <p>æŒ‰ä¸‹ç©ºæ ¼é”®æˆ–ç‚¹å‡»æŒ‰é’®å¼€å§‹</p>
        <p style="font-size: 16px; color: #ccc;">(æ³¨æ„ï¼šè¯·è·ŸéšéŸ³ä¹èŠ‚å¥è·³è·ƒ)</p>
        <br>
        <button id="start-btn">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div id="game-over-screen" class="overlay hidden">
        <h1 id="end-title">Game Over</h1>
        <p>æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></p>
        <br>
        <button id="restart-btn">å†æ¥ä¸€å±€</button>
    </div>
</div>

<audio id="bgm" src="src/ä¸€é¢—è‹¹æœ.mp3" preload="auto"></audio>
<audio id="sfx-eat"></audio>

<script>
    // ==================== JavaScript æ¸¸æˆé€»è¾‘ ====================

    // --- 1. å…¨å±€å˜é‡ä¸é…ç½® ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score-board');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finalScoreElement = document.getElementById('final-score');
    const bgm = document.getElementById('bgm');

    // æ¸¸æˆé…ç½®
    const GRAVITY = 0.75;       // é‡åŠ›
    const JUMP_FORCE = -15;    // è·³è·ƒåŠ›åº¦
    const GROUND_Y = 438;      // åœ°é¢é«˜åº¦åæ ‡
    const SCROLL_SPEED = 6.25;    // æ¸¸æˆæ»šåŠ¨é€Ÿåº¦ (åƒç´ /å¸§)
    // ğŸ‘‡ === æ–°å¢ï¼šåœ¨è¿™é‡Œæ·»åŠ  lastTime å˜é‡ ===
    let lastTime = 0;    //ç”¨äºè®°å½•ä¸Šä¸€å¸§çš„æ—¶é—´æˆ³
    const BPM = 130;
    const SECONDS_PER_BEAT = 60.0 / BPM;
    const SPAWN_LEAD_TIME = (1000 - 125) / (SCROLL_SPEED * 60);

    //  === å½•åˆ¶æ¨¡å¼å¼€å…³ ===
    // ã€å¹³æ—¶ç©è®¾ä¸º falseã€‘ã€‚éœ€è¦åˆ¶ä½œè°±é¢æ—¶è®¾ä¸º trueã€‚
    const RECORD_MODE = false;
    // ç”¨æ¥ä¸´æ—¶å­˜å‚¨ä½ å½•ä¸‹çš„èŠ‚å¥
    let recordedLevel = [];

    let gameState = 'START'; // START, PLAYING, GAMEOVER
    let score = 0;
    let frames = 0;
    let gameLoopId = null;
    const catImage = new Image();

    // è¿™é‡Œå¡«ä½ çš„å›¾ç‰‡è·¯å¾„ï¼Œå‡è®¾ä½ çš„å›¾ç‰‡å« cat_run.png
    // å›¾ç‰‡åº”è¯¥æ˜¯ä¸€å¼ æ¨ªæ¡ï¼Œæ¯”å¦‚å®½ 200px é«˜ 50pxï¼ŒåŒ…å« 4 å¸§ï¼Œæ¯å¸§ 50x50
    catImage.src = 'src/img/default.png';

    //  === åŠ è½½èƒŒæ™¯å›¾æ•°ç»„ ===
    const bgFiles = ['src/img/bg1.png', 'src/img/bg1b.png',  'src/img/bg1f.png',
        'src/img/bg1s.png', 'src/img/bg12026.png',
        'src/img/bg2.png', 'src/img/bg2b.png',  'src/img/bg2f.png',
        'src/img/bg2s.png', 'src/img/bg22026.png'];

    const bgImages = [];
    bgFiles.forEach(src => {
        const img = new Image();
        img.src = src; // ç¡®ä¿è¿™äº›å›¾ç‰‡éƒ½åœ¨ä½ çš„æ–‡ä»¶å¤¹é‡Œ
        bgImages.push(img);
    });
    // å®šä¹‰ä½ æƒ³è¦çš„æ’­æ”¾é¡ºåº (å¯¹åº” bgImages çš„ç´¢å¼•ï¼Œä»0å¼€å§‹)
    const bgSequence = [5,5,5,5,5,5,5,5,5,5, 5,5,5,5,5,5,5,5,6,8,   8,5,5,5,5,5,5,5,7,9];

    const appleSprite = new Image();
    appleSprite.src = 'src/img/apple_anim.png';

    const obstacleImage = new Image();
    obstacleImage.src = 'src/img/obstacle.png'; // æ¯”å¦‚æ ‘æ¡©ã€çŸ³å¤´

    let background;
    let decorations = [];

    const cuteImages = [];
    const cuteSources = ['src/img/ashin_pink.png', 'src/img/masa_yellow.png', 'src/img/ming_blue.png',
        'src/img/monster_red.png', 'src/img/stone_green.png']; // ä½ çš„æ–‡ä»¶å
    cuteSources.forEach(src => {
        const img = new Image();
        img.src = src;
        cuteImages.push(img);
    });

    // --- 2. æ ¸å¿ƒï¼šå…³å¡æ•°æ® (è°±é¢) ---
    // è¿™é‡Œçš„ 'time' æ˜¯éŸ³ä¹æ’­æ”¾çš„ç§’æ•°ã€‚å½“éŸ³ä¹æ’­æ”¾åˆ°è¿™ä¸ªæ—¶é—´ç‚¹æ—¶ï¼Œç‰©ä½“ä¼šåœ¨å±å¹•å³ä¾§ç”Ÿæˆã€‚
    // è¿™æ˜¯ä¸€ä¸ªé¢„è®¾çš„æ¼”ç¤ºè°±é¢ã€‚
    let levelIndex = 0; // ç”¨äºè¿½è¸ªå½“å‰è¯»å–åˆ°è°±é¢çš„ç¬¬å‡ ä¸ªæ•°æ®

    // ğŸ‘‡ === æ ¸å¿ƒæ”¹åŠ¨ 1: å˜é‡åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ ===
    let LEVEL_DATA = [];
    //obstacle
    // ğŸ‘† ===================================

    // ğŸ‘‡ === æ ¸å¿ƒæ”¹åŠ¨ 2: æ–°å¢è¯»å– JSON çš„å‡½æ•° ===
    async function loadLevelData() {
        try {
            // è¯»å–åŒçº§ç›®å½•ä¸‹çš„ level.json
            const response = await fetch('src/level.json');

            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
            }

            LEVEL_DATA = await response.json();

            // æ•°æ®åŠ è½½æˆåŠŸï¼Œå¯ç”¨å¼€å§‹æŒ‰é’®
            // console.log("å…³å¡æ•°æ®åŠ è½½æˆåŠŸ:", LEVEL_DATA);

        } catch (error) {
            console.error("åŠ è½½å¤±è´¥:", error);
        }
    }
    // é¡µé¢åŠ è½½æ—¶ç«‹å³è°ƒç”¨
    loadLevelData();
    // ğŸ‘† ======================================

    // --- 3. æ¸¸æˆå¯¹è±¡ç±»å®šä¹‰ ---

    // ç©å®¶ (å°çŒ«) ç±»
    class Player {
        constructor() {
            this.width = 100;
            this.height = 100;
            this.x = 125; // å›ºå®šåœ¨å±å¹•å·¦ä¾§
            this.y = GROUND_Y - this.height;
            this.velocityY = 0;
            this.isJumping = false;
            this.frameX = 0;       // å½“å‰åœ¨ç¬¬å‡ å¸§ (0, 1, 2, 3...)
            this.maxFrame = 7;     // æ€»å…±æœ‰å¤šå°‘å¸§ - 1 (å‡è®¾æœ‰4å¸§ï¼Œè¿™é‡Œå¡«3)
            this.fps = 10;         // åŠ¨ç”»é€Ÿåº¦ (æ¯ç§’åˆ‡å¤šå°‘å¸§)
            this.frameTimer = 0;   // è®¡æ—¶å™¨
            this.frameInterval = 1000 / this.fps; // æ¯å¸§é—´éš”æ—¶é—´
        }

        draw() {
            // å‡è®¾åŸå›¾ä¸­æ¯ä¸€å¸§çš„çœŸå®å®½åº¦ (Source Width)
            // å¦‚æœæ•´å¼ å›¾å®½ 200ï¼Œæœ‰ 4 å¸§ï¼Œé‚£æ¯å¸§å°±æ˜¯ 50
            const spriteWidth = 500;
            const spriteHeight = 500;
            // ctx.fillStyle = this.color;
            // // ç”¨ç®€å•çš„çŸ©å½¢ä»£æ›¿çŒ«çš„å›¾ç‰‡
            // ctx.fillRect(this.x, this.y, this.width, this.height);
            // // åŠ ä¸ªå°è€³æœµè¡¨ç¤ºæ–¹å‘
            // ctx.fillStyle = '#FF8800';
            // ctx.beginPath();
            // ctx.moveTo(this.x + 30, this.y);
            // ctx.lineTo(this.x + 40, this.y - 10);
            // ctx.lineTo(this.x + 50, this.y + 10);
            // ctx.fill();
            // ğŸ‘‡ === ä¿®æ”¹ï¼šç»˜åˆ¶å›¾ç‰‡ ===
            // ctx.drawImage(å›¾ç‰‡å¯¹è±¡,
            //    æºå›¾åˆ‡å‰²X, æºå›¾åˆ‡å‰²Y, åˆ‡å‰²å®½, åˆ‡å‰²é«˜, (è¿™4ä¸ªå‚æ•°å†³å®šåˆ‡å“ªä¸€å—)
            //    ç”»å¸ƒä½ç½®X, ç”»å¸ƒä½ç½®Y, ç”»å¸ƒå®½, ç”»å¸ƒé«˜  (è¿™4ä¸ªå‚æ•°å†³å®šç”»åœ¨å“ªé‡Œ)
            // )
            ctx.drawImage(
                catImage,
                this.frameX * spriteWidth, 0, spriteWidth, spriteHeight,
                this.x, this.y, this.width, this.height
            );

            // (å¯é€‰) ç»˜åˆ¶ä¸€ä¸ªçº¢æ¡†æ–¹ä¾¿è°ƒè¯•ç¢°æ’ç®±ï¼Œæ­£å¼å‘å¸ƒæ—¶åˆ æ‰
            // ctx.strokeStyle = 'red';
            // ctx.strokeRect(this.x, this.y, this.width, this.height);
        }

        update(deltaTime) {
            // åº”ç”¨ç‰©ç†
            this.y += this.velocityY;

            // å¦‚æœåœ¨ç©ºä¸­ï¼Œåº”ç”¨é‡åŠ›
            if (this.y + this.height < GROUND_Y) {
                this.velocityY += GRAVITY;
                this.isJumping = true;
            } else {
                // è½åœ°
                this.y = GROUND_Y - this.height;
                this.velocityY = 0;
                this.isJumping = false;
            }
            if (this.isJumping) {
                // å¦‚æœåœ¨è·³è·ƒï¼Œé€šå¸¸å›ºå®šæ˜¾ç¤ºæŸä¸€å¸§ï¼ˆæ¯”å¦‚ç¬¬2å¸§ï¼‰ï¼Œæˆ–è€…æš‚åœåŠ¨ç”»
                this.frameX = 4;
            } else {
                // å¦‚æœåœ¨è·‘åŠ¨ï¼Œå°±å¾ªç¯æ’­æ”¾å›¾ç‰‡
                if(isNaN(this.frameTimer)){
                    this.frameTimer = 0;
                }
                if (this.frameTimer > this.frameInterval) {
                    if (this.frameX >= this.maxFrame) {
                        this.frameX = 0; // æ’­å®Œä¸€è½®ï¼Œå›åˆ°ç¬¬ä¸€å¸§
                    } else {
                        this.frameX++;   // ä¸‹ä¸€å¸§
                    }
                    this.frameTimer = 0;
                } else {
                    // ç´¯åŠ æ—¶é—´ (éœ€è¦ç”¨åˆ° deltaTime)

                    this.frameTimer += deltaTime;
                }
            }
        }

        jump() {
            if (!this.isJumping) {
                this.velocityY = JUMP_FORCE;
            }
        }
    }

    // éšœç¢ç‰©å’Œè‹¹æœçš„åŸºç±»
    class GameEntity {
        constructor(data) {
            this.type = data.type;
            this.text = data.text;
            this.width = 38;
            this.height = 38;
            this.widthsize = 38;
            this.heightsize = 38;
            this.x = canvas.width; // ä»å±å¹•æœ€å³ä¾§ç”Ÿæˆ
            // è‹¹æœåœ¨ç©ºä¸­ï¼Œéšœç¢åœ¨åœ°ç”Ÿ
            if (this.type === 'apple') {
                this.y = GROUND_Y - 150;
            } else if (this.type === 'lyric') {
                this.y = GROUND_Y - 250; // æ­Œè¯é£˜åœ¨æ›´é«˜çš„åœ°æ–¹ï¼Œä¸æŒ¡è·¯
            } else {
                this.y = GROUND_Y - 38;  // éšœç¢ç‰©åœ¨åœ°é¢
            }
            this.markedForDeletion = false;

            this.frameX = 0;        // å½“å‰æ’­æ”¾ç¬¬å‡ å¸§
            // å¦‚æœæ˜¯è‹¹æœï¼Œæœ€å¤§å¸§ç´¢å¼•æ˜¯1 (å…±2å¸§)ï¼›å¦‚æœæ˜¯éšœç¢ï¼Œæ˜¯0 (ä¸åŠ¨ç”»)
            this.maxFrame = (this.type === 'apple') ? 1 : 0;
            this.fps = 2;           // åŠ¨ç”»é€Ÿåº¦ (ä¸ç”¨å¤ªå¿«ï¼Œæ¯ç§’6å¸§å³å¯)
            this.frameTimer = 0;    // è®¡æ—¶å™¨
            this.frameInterval = 1000 / this.fps;
        }

        draw() {
            let imgSource;
            if (this.type === 'lyric') {
                ctx.save(); // ä¿å­˜å½“å‰ç”»ç¬”çŠ¶æ€
                ctx.fillStyle = "#01b6fd"; // å­—ä½“é¢œè‰²
                ctx.font = "bold 106px 'Microsoft YaHei', sans-serif"; // å­—ä½“å¤§å° (è®°å¾—é…åˆç”»å¸ƒç¼©æ”¾)
                ctx.strokeStyle = "white"; // æè¾¹é¢œè‰²
                ctx.lineWidth = 4;

                // ç»˜åˆ¶æè¾¹ (è®©æ–‡å­—æ›´æ¸…æ¥š)
                ctx.strokeText(this.text, this.x, this.y);
                // ç»˜åˆ¶å®ä½“å­—
                ctx.fillText(this.text, this.x, this.y);

                ctx.restore(); // æ¢å¤ç”»ç¬”
                return; // ç”»å®Œæ­Œè¯ç›´æ¥ç»“æŸï¼Œä¸ç”»åé¢çš„å›¾ç‰‡äº†
            }
            if (this.type === 'apple') {
                imgSource = appleSprite;
                this.widthsize = 380;
                this.heightsize = 380;
            } else {
                imgSource = obstacleImage;
            }
            if (imgSource && imgSource.complete) {
                // æ ¸å¿ƒå˜åŒ–åœ¨è¿™é‡Œï¼š
                // æ ¹æ® this.frameX è®¡ç®—ä»åŸå›¾çš„å“ªé‡Œå¼€å§‹åˆ‡
                const sourceX = this.frameX * this.width;

                ctx.drawImage(
                    imgSource,          // å›¾ç‰‡æº
                    sourceX, 0,         // æºå›¾èµ·ç‚¹ X, Y (æ ¹æ®å¸§æ•°å˜åŒ–)
                    this.widthsize, this.heightsize, // æºå›¾åˆ‡å¤šå¤§ (ä¸€å¸§çš„å¤§å°)
                    this.x, this.y,     // ç”»å¸ƒç›®æ ‡ X, Y
                    this.width, this.height  // ç”»å¸ƒç›®æ ‡ç”»å¤šå¤§
                );
            } else {
                // (å¯é€‰) å¦‚æœå›¾ç‰‡è¿˜æ²¡åŠ è½½å‡ºæ¥ï¼Œæš‚æ—¶ç”»ä¸ªè‰²å—ä»£æ›¿ï¼Œé˜²æ­¢çœ‹ä¸è§
                ctx.fillStyle = (this.type === 'apple') ? 'red' : 'brown';
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        update(deltaTime) {
            // å‘å·¦ç§»åŠ¨
            this.x -= SCROLL_SPEED;
            // ç§»å‡ºå±å¹•å·¦ä¾§åˆ™æ ‡è®°åˆ é™¤
            if (this.x + this.width < -1000) {
                this.markedForDeletion = true;
            }
            // B. åŠ¨ç”»å¸§é€»è¾‘ (åªæœ‰ maxFrame > 0 æ—¶æ‰éœ€è¦è®¡ç®—)
            if (this.maxFrame > 0) {
                this.frameTimer += deltaTime;
                if (this.frameTimer > this.frameInterval) {
                    this.frameX++;
                    // å¾ªç¯æ’­æ”¾ï¼šå¦‚æœè¶…è¿‡æœ€å¤§å¸§ï¼Œå›åˆ°0
                    if (this.frameX > this.maxFrame) {
                        this.frameX = 0;
                    }
                    this.frameTimer = 0; // é‡ç½®è®¡æ—¶å™¨
                }
            }
        }
    }

    //  === èƒŒæ™¯ç±» ===
    class BackgroundLayer {
        constructor(images, sequence, speedModifier) {
            this.images = images;       // å›¾ç‰‡å¯¹è±¡æ•°ç»„
            this.sequence = sequence;   // é¡ºåºæ•°ç»„ [0, 0, 1...]
            this.speedModifier = speedModifier; // è§†å·®ç³»æ•° (0.5è¡¨ç¤ºåŠé€Ÿï¼Œ1.0è¡¨ç¤ºå…¨é€Ÿ)
            this.speed = SCROLL_SPEED * this.speedModifier;
            this.x = 0;
            this.y = 0;
            this.width = 1000;  // å‡è®¾èƒŒæ™¯å›¾å®½åº¦å’Œç”»å¸ƒä¸€è‡´
            this.height = 500;

            this.currentIndex = 0; // å½“å‰æ’­æ”¾åˆ°åºåˆ—çš„ç¬¬å‡ ä¸ª
        }

        update() {
            // æ ¹æ®æ¸¸æˆé€Ÿåº¦ç§»åŠ¨
            this.speed = SCROLL_SPEED * this.speedModifier;
            // å‘å·¦ç§»åŠ¨
            this.x -= this.speed;

            // æ ¸å¿ƒé€»è¾‘ï¼šå½“å½“å‰çš„ä¸€å¼ å›¾å®Œå…¨ç§»å‡ºå±å¹•å·¦ä¾§æ—¶
            if (this.x <= -this.width) {
                // 1. æŠŠåæ ‡æ‹‰å›æ¥ (ä¸å…¶é‡ç½®ä¸º0ï¼Œä¸å¦‚åŠ ä¸Šwidthï¼Œé˜²æ­¢æµ®ç‚¹æ•°è®¡ç®—å¯¼è‡´çš„ç¼éš™)
                this.x += this.width;

                // 2. æŒ‡é’ˆç§»å‘åºåˆ—çš„ä¸‹ä¸€ä¸ª
                this.currentIndex++;

                // 3. å¦‚æœåºåˆ—æ’­å®Œäº†ï¼Œå¾ªç¯å›åˆ°å¼€å¤´
                if (this.currentIndex >= this.sequence.length) {
                    this.currentIndex = 0;
                }
            }
        }

        draw() {
            // æˆ‘ä»¬éœ€è¦æ‰¾å‡º "å½“å‰è¿™ä¸€å¼ " å’Œ "ç´§æ¥ç€çš„ä¸‹ä¸€å¼ "

            // 1. è·å–å½“å‰å›¾ç‰‡çš„ç´¢å¼•
            let currentImgIndex = this.sequence[this.currentIndex];
            let currentImg = this.images[currentImgIndex];

            // 2. è·å–ä¸‹ä¸€å¼ å›¾ç‰‡çš„ç´¢å¼• (å¤„ç†å¾ªç¯æƒ…å†µ)
            let nextSeqIndex = this.currentIndex + 1;
            if (nextSeqIndex >= this.sequence.length) {
                nextSeqIndex = 0; // å¦‚æœåˆ°äº†æœ«å°¾ï¼Œä¸‹ä¸€å¼ å°±æ˜¯å¼€å¤´
            }
            let nextImgIndex = this.sequence[nextSeqIndex];
            let nextImg = this.images[nextImgIndex];

            // 3. ç»˜åˆ¶
            // ç”»å½“å‰å¼  (åœ¨ x ä½ç½®)
            if (currentImg && currentImg.complete) {
                ctx.drawImage(currentImg, this.x, this.y, this.width, this.height);
            }

            // ç”»ä¸‹ä¸€å¼  (åœ¨ x + width ä½ç½®ï¼Œå³ç´§è´´ç€å½“å‰å¼ çš„å±è‚¡åé¢)
            if (nextImg && nextImg.complete) {
                ctx.drawImage(nextImg, this.x + this.width, this.y, this.width, this.height);
            }
        }
    }

    //  === å¯çˆ±è£…é¥°ç‰©ç±» ===
    class CuteDecoration {
        constructor() {
            // éšæœºé€‰ä¸€å¼ å›¾
            this.image = cuteImages[Math.floor(Math.random() * cuteImages.length)];
            // åŸå§‹å¤§å° (æ ¹æ®ä½ çš„å›¾ç‰‡è°ƒæ•´)
            this.spriteW = 150;
            this.spriteH = 150;
            // éšæœºç¼©æ”¾ä¸€ç‚¹ç‚¹ (0.5å€ åˆ° 1.5å€)
            this.scale = Math.random() * 1 + 0.5;
            this.width = this.spriteW * this.scale;
            this.height = this.spriteH * this.scale;

            this.x = canvas.width + Math.random() * 200; // åœ¨å±å¹•å³ä¾§éšæœºä½ç½®ç”Ÿæˆ
            this.y = Math.random() * (GROUND_Y - 300);    // åœ¨ç©ºä¸­éšæœºé«˜åº¦

            // éšæœºé€Ÿåº¦ï¼šè¿œçš„æ…¢ï¼Œè¿‘çš„å¿«ï¼Œåˆ¶é€ ç©ºé—´æ„Ÿ
            this.speed = (Math.random() * 2 +1);
            this.markedForDeletion = false;

            // ç®€å•çš„ä¸Šä¸‹æµ®åŠ¨æ•ˆæœå‚æ•°
            this.angle = 0;
            this.angleSpeed = Math.random() * 0.1;
        }

        update() {
            this.x -= this.speed;
            // è®©å®ƒä¸Šä¸‹è½»è½»æ¼‚æµ®
            this.angle += this.angleSpeed;
            this.y += Math.sin(this.angle);

            if (this.x + this.width < 0) this.markedForDeletion = true;
        }

        draw() {
            if (this.image.complete) { // ç¡®ä¿å›¾ç‰‡åŠ è½½å®Œäº†å†ç”»
                ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
            } else {
                // å›¾ç‰‡æ²¡åŠ è½½å‡ºæ¥æ—¶ç”»ä¸ªåœ†åœˆä»£æ›¿
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath(); ctx.arc(this.x, this.y, 10, 0, Math.PI*2); ctx.fill();
            }
        }
    }


    // --- 4. æ¸¸æˆå®ä¾‹åˆå§‹åŒ– ---
    let player = new Player();
    let entities = []; // å­˜æ”¾å±å¹•ä¸Šæ‰€æœ‰çš„è‹¹æœå’Œéšœç¢

    // --- 5. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

    function initGame() {
        // é‡ç½®å˜é‡
        score = 0;
        levelIndex = 0;
        frames = 0;
        entities = [];
        player = new Player();
        scoreElement.innerText = 'Score: ' + score;
        //  === 4. åˆå§‹åŒ–èƒŒæ™¯å’Œè£…é¥°åˆ—è¡¨ ===
        // å‚æ•°1: å›¾ç‰‡æ•°ç»„, å‚æ•°2: é¡ºåºæ•°ç»„, å‚æ•°3: é€Ÿåº¦ç³»æ•°
        // 0.5 è¡¨ç¤ºèƒŒæ™¯ç§»åŠ¨é€Ÿåº¦æ˜¯å‰æ™¯çš„ä¸€åŠ (è§†å·®æ•ˆæœ)

        background = new BackgroundLayer(bgImages, bgSequence, 0.5);
        decorations = [];
        // é‡ç½®éŸ³ä¹
        bgm.currentTime = 0;
        // æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³é¢‘ï¼Œæ‰€ä»¥æ”¾åœ¨ç‚¹å‡»äº‹ä»¶é‡Œ
        bgm.play().catch(e => console.log("éœ€è¦ç”¨æˆ·ç‚¹å‡»æ‰èƒ½æ’­æ”¾éŸ³é¢‘"));
        // gameStartTime = audioCtx.currentTime;
        lastTime = performance.now(); // è·å–å½“å‰ç²¾ç¡®æ—¶é—´ä½œä¸ºèµ·ç‚¹

        gameState = 'PLAYING';
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');

        if (gameLoopId) cancelAnimationFrame(gameLoopId);
        gameLoop();
    }

    function gameOver(isVictory = false) {
        gameState = 'GAMEOVER';
        bgm.pause();
        cancelAnimationFrame(gameLoopId);

        const endTitle = document.getElementById('end-title');
        endTitle.innerText = isVictory ? "Victory! å†åƒä¸€é¢—è‹¹æœ^_^" : "Game Over!";
        endTitle.style.color = isVictory ? "#4CAF50" : "#FF6B6B";

        finalScoreElement.innerText = score;
        gameOverScreen.classList.remove('hidden');
        // ğŸ‘‡ === å¯¼å‡ºæ•°æ® ===
        if (RECORD_MODE) {
            console.log("============ ä½ çš„è°±é¢ JSON ============");
            // æŠŠæ•°ç»„è½¬æˆ JSON å­—ç¬¦ä¸²è¾“å‡º
            console.log(JSON.stringify(recordedLevel, null, 4));
            console.log("======================================");
            alert("è°±é¢å·²ç”Ÿæˆï¼è¯·æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°(Console) å¤åˆ¶ JSON æ•°æ®ã€‚");
        }
    }

    // ç®€å•çš„çŸ©å½¢ç¢°æ’æ£€æµ‹ (AABB)
    function checkCollision(rect1, rect2) {
        return (
            rect1.x < rect2.x + rect2.width &&
            rect1.x + rect1.width > rect2.x &&
            rect1.y < rect2.y + rect2.height &&
            rect1.y + rect1.height > rect2.y
        );
    }

    // ç”Ÿæˆå™¨ï¼šæ£€æŸ¥éŸ³ä¹æ—¶é—´ï¼Œå†³å®šæ˜¯å¦ç”Ÿæˆç‰©ä½“
    function spawnManager() {
        // å¦‚æœè°±é¢è¯»å®Œäº†ï¼Œå°±è¿”å›
        if (levelIndex >= LEVEL_DATA.length) return;

        const nextSpawn = LEVEL_DATA[levelIndex];
        // è®¡ç®—ç›®æ ‡æ—¶é—´ï¼šæ‹æ•° * æ¯æ‹ç§’æ•°
        // const targetTime = nextSpawn.beat * SECONDS_PER_BEAT;
        let targetTime = nextSpawn.time - SPAWN_LEAD_TIME;


        // æ ¸å¿ƒï¼šæ¯”è¾ƒå½“å‰éŸ³ä¹æ’­æ”¾æ—¶é—´å’Œè°±é¢è®¾å®šçš„æ—¶é—´
        // ä½¿ç”¨ä¸€ä¸ªå°çš„ç¼“å†²èŒƒå›´ (0.1ç§’) ç¡®ä¿ä¸ä¼šé”™è¿‡èŠ‚å¥ç‚¹
        if (bgm.currentTime >= targetTime - 0.1) {
            if (nextSpawn.type === 'end') {
                gameOver(true); // èƒœåˆ©é€šå…³
            } else {
                entities.push(new GameEntity(nextSpawn));
                levelIndex++;
            }
        }

        // å¦‚æœéŸ³ä¹æ’­å®Œäº†ï¼Œä¹Ÿç»“æŸæ¸¸æˆ (ä½œä¸ºå¤‡ç”¨èƒœåˆ©æ¡ä»¶)
        if (bgm.ended && gameState === 'PLAYING') {
            gameOver(true);
        }
    }

    // --- 6. æ¸¸æˆä¸»å¾ªç¯ (æ¯ä¸€å¸§è¿è¡Œä¸€æ¬¡) ---
    function gameLoop(timestamp) {
        if (gameState !== 'PLAYING') return;
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œtimestamp å¯èƒ½ä¼šæœªå®šä¹‰æˆ–è€…å¯¼è‡´å·¨å¤§çš„å·®å€¼ï¼Œåšä¸ªä¿åº•

        if (!lastTime) lastTime = timestamp;
        //  ===  è®¡ç®—æ—¶é—´å·® ===
        let deltaTime = timestamp - lastTime;
        lastTime = timestamp;
        // (é˜²æ­¢åˆ‡æ¢æ ‡ç­¾é¡µåå›æ¥ deltaTime è¿‡å¤§å¯¼è‡´é£å‡ºå±å¹•ï¼Œä½†è¿™åªæ˜¯ä¸ªä¿é™©)
        if (deltaTime > 100) deltaTime = 16;
        // A. æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // å…ˆç”»èƒŒæ™¯ (æœ€åº•å±‚)
        background.update();
        background.draw();


        // B. ç»˜åˆ¶åœ°é¢çº¿
        ctx.beginPath();
        ctx.moveTo(0, GROUND_Y);
        ctx.lineTo(canvas.width, GROUND_Y);
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 3;
        ctx.stroke();
        // å¤„ç†è£…é¥°ç‰©
        handleDecorations();

        // C. æ›´æ–°å’Œç»˜åˆ¶ç©å®¶
        player.update(deltaTime);
        player.draw();

        // D. ç”Ÿæˆç®¡ç† (åŸºäºéŸ³ä¹æ—¶é—´)
        spawnManager();

        // E. æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰å®ä½“ (è‹¹æœ/éšœç¢)
        // å€’åºéå†ä»¥ä¾¿å®‰å…¨åˆ é™¤å…ƒç´ 
        for (let i = entities.length - 1; i >= 0; i--) {
            let entity = entities[i];
            entity.update(deltaTime);
            entity.draw();

            // ç¢°æ’æ£€æµ‹
            if (checkCollision(player, entity)) {
                if (entity.type === 'apple') {
                    // åƒåˆ°è‹¹æœ
                    score += 100;
                    scoreElement.innerText = 'Score: ' + score;
                    entity.markedForDeletion = true; // åƒæ‰åæ¶ˆå¤±
                    // æ’­æ”¾ä¸€ä¸ªç®€å•çš„æç¤ºéŸ³ (å¯é€‰ï¼Œéœ€è¦å‡†å¤‡éŸ³é¢‘æ–‡ä»¶)
                    // sfxEat.play();
                } else if (entity.type === 'obstacle') {
                    // æ’åˆ°éšœç¢
                    gameOver(false);
                }
            }

            // æ¸…ç†ç§»å‡ºå±å¹•æˆ–è¢«åƒæ‰çš„å®ä½“
            if (entity.markedForDeletion) {
                entities.splice(i, 1);
            }
        }


        frames++;
        // è¯·æ±‚ä¸‹ä¸€å¸§åŠ¨ç”»
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    //  === è£…é¥°ç‰©ç”Ÿæˆç®¡ç†å™¨ ===
    function handleDecorations() {
        // æ¯éš”ä¸€å°ä¼šå„¿éšæœºç”Ÿæˆä¸€ä¸ª (çº¦ 0.2% çš„æ¦‚ç‡æ¯å¸§)
        if (Math.random() < 0.0002) {
            decorations.push(new CuteDecoration());
        }

        // å¾ªç¯æ›´æ–°å’Œç»˜åˆ¶
        for (let i = decorations.length - 1; i >= 0; i--) {
            decorations[i].update();
            decorations[i].draw();
            if (decorations[i].markedForDeletion) {
                decorations.splice(i, 1);
            }
        }
    }


    // --- 7. è¾“å…¥äº‹ä»¶ç›‘å¬ ---

    // é”®ç›˜æ§åˆ¶ (ç©ºæ ¼é”®è·³è·ƒ/å¼€å§‹)
    document.addEventListener('keydown', (e) => {

        if (e.code === 'Space') {
            if (gameState === 'START' || gameState === 'GAMEOVER') {
                initGame();
            } else if (gameState === 'PLAYING') {
                player.jump();
                // ğŸ‘‡ === å½•åˆ¶é€»è¾‘å¼€å§‹ ===
                if (RECORD_MODE ) {
                    // 1. è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ æ‹
                    const currentTime = bgm.currentTime;

                    // 2. ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰å½•å…¥çš„éƒ½æš‚æ—¶å½“åš "apple"
                    // (ä½ å¯ä»¥ä¹‹ååœ¨ JSON é‡Œæ‰‹åŠ¨æŠŠä¸€éƒ¨åˆ† apple æ”¹æˆ obstacle)
                    console.log(`ğŸµ è®°å½•èŠ‚å¥ç‚¹:  ${currentTime} `);

                    recordedLevel.push({
                        "time": currentTime,
                        "type": "apple" // é»˜è®¤å…ˆå…¨æ˜¯è‹¹æœ
                    });
                }
            }
        }
    });

    // é¼ æ ‡/è§¦æ‘¸ç‚¹å‡»æ§åˆ¶ (é€‚é…ç§»åŠ¨ç«¯)
    canvas.addEventListener('touchstart', handleTap);
    canvas.addEventListener('mousedown', handleTap);

    function handleTap(e) {
        if (gameState === 'PLAYING') {
            player.jump();
            // é˜²æ­¢åœ¨ç§»åŠ¨ç«¯è§¦å‘æ»šåŠ¨å’Œé»˜è®¤çš„é¼ æ ‡äº‹ä»¶
            e.preventDefault();
        }
    }




    // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('start-btn').addEventListener('click', initGame);
    document.getElementById('restart-btn').addEventListener('click', initGame);

    // ğŸ‘‡ === å¿…é¡»ä½¿ç”¨ window ç›‘å¬ï¼Œå®ç°â€œå…¨å±ç›²æŒ‰â€ ===
    window.addEventListener('touchstart', (e) => {
        // å¿½ç•¥å¤šç‚¹è§¦æ§
        if (e.touches.length > 1) return;

        // åªè¦æ˜¯æ¸¸æˆè¿›è¡Œä¸­ï¼Œç‚¹å±å¹•ä»»ä½•åœ°æ–¹ï¼ˆåŒ…æ‹¬é»‘è¾¹ï¼‰éƒ½ç®—è·³
        if (gameState === 'PLAYING') {
            player.jump();
            e.preventDefault(); // é˜²æ­¢ç‚¹å‡»äº§ç”Ÿçš„é«˜äº®æˆ–æ»šåŠ¨
        }
        // æ³¨æ„ï¼šéæ¸¸æˆçŠ¶æ€ä¸‹(Start/GameOver)ï¼Œè¿˜æ˜¯è®©æŒ‰é’®å»å¤„ç†ç‚¹å‡»ï¼Œè¿™é‡Œä¸è¦æ‹¦æˆª
    }, { passive: false });


</script>
</body>
</html>